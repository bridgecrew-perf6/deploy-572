version: '3.8'

x-placement: &local-placement
  placement:
    constraints:
      - node.labels.pastvu.pastvu-data == true
x-defaults: &app-default
  image: pastvu/backend:${TAG?ERR}
  configs:
    - source: config.js
      target: /code/config/local.config.js

services:

  fileserver:
    deploy: *local-placement
    image: pastvu/fileserver:${TAG_FILESERVER?ERR}
    networks:
      - frontend
    volumes:
      - store:/store:ro
      - sitemap:/sitemap:ro

  frontend_ru:
    image: pastvu/frontend:${TAG?ERR}

  frontend_en:
    image: pastvu/frontend:${TAG_EN?ERR}

  app_primary:
    << : *app-default 
    networks:
      - backend
    environment:
      - DOMAIN
      - PROTOCOL
    deploy:
      << : *local-placement
      mode: global
    command: "bin/run --primary"

  app_ru:
    << : *app-default
    deploy: *local-placement
    environment:
      - DOMAIN
      - PROTOCOL
    networks:
      - frontend
      - backend
    volumes:
      - store:/store

  app_en:
    << : *app-default
    deploy: *local-placement
    image: pastvu/backend:${TAG_EN?ERR}
    networks:
      - frontend
      - backend
    environment:
      - DOMAIN
      - PROTOCOL
    volumes:
      - store:/store

  notifier_ru:
    << : *app-default 
    networks:
      - backend
    environment:
      - DOMAIN
      - PROTOCOL
    deploy:
      << : *local-placement
      mode: global
    command: "bin/run --script notifier"

  notifier_en:
    << : *app-default 
    image: pastvu/backend:${TAG_EN:?ERR}
    networks:
      - backend
    environment:
      - DOMAIN
      - PROTOCOL
    deploy: 
      << : *local-placement
      mode: global
    command: "bin/run --script notifier"

  uploader:
    << : *app-default
    deploy:
      << : *local-placement
      mode: global
    networks:
      - frontend
      - backend
    volumes:
      - store:/store
    command: "bin/run --script uploader"

  downloader:
    << : *app-default
    deploy: *local-placement
    networks:
      - frontend
      - backend
    volumes:
      - store:/store:ro
    command: "bin/run --script downloader"

  sitemap:
    << : *app-default
    deploy: *local-placement
    networks:
      - backend
    environment:
      - DOMAIN
      - PROTOCOL
    volumes:
      - sitemap:/sitemap
    command: "bin/run --script sitemap"

  api:
    << : *app-default
    networks:
      - backend

  mongo:
    deploy:
      << : *local-placement
      mode: global
    image: pastvu/mongo:3.2.22
    networks:
      - backend
      - mongo
    volumes:
      - mongo:/data/db

  redis:
    image: redis:6.2.6
    networks:
      - backend

configs:
  config.js:
    file: ${CONFIG:?ERR}
    name: pastvu_config_${CONFIG_TAG:?ERR}

networks:
  frontend:
  backend:
  mongo:
    attachable: true

volumes:
  store:
  sitemap:
  mongo:
